{"version":3,"sources":["../../src/util/jazz_instance.js"],"names":["createJazzInstance","getJazzInstance","jazzPluginInitTime","browser","jazzInstanceNumber","jazzInstances","callback","id","Date","now","objRef","activeX","nodejs","navigator","jazzMidi","MIDI","document","createElement","classid","type","appendChild","p","createTextNode","a","href","insertionPoint","getElementById","style","position","visibility","left","top","body","setTimeout","instance","isJazz","_perfTimeZero","performance","set","key","values","i","length","inst"],"mappings":"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","file":"jazz_instance.js","sourcesContent":["/* eslint no-underscore-dangle: 0 */\n\n/*\n  Creates instances of the Jazz plugin if necessary. Initially the MIDIAccess creates one main Jazz instance that is used\n  to query all initially connected devices, and to track the devices that are being connected or disconnected at runtime.\n\n  For every MIDIInput and MIDIOutput that is created, MIDIAccess queries the getJazzInstance() method for a Jazz instance\n  that still have an available input or output. Because Jazz only allows one input and one output per instance, we\n  need to create new instances if more than one MIDI input or output device gets connected.\n\n  Note that an existing Jazz instance doesn't get deleted when both its input and output device are disconnected; instead it\n  will be reused if a new device gets connected.\n*/\n\nimport Store from './store';\nimport { getDevice } from './util';\n\nconst jazzPluginInitTime = getDevice().browser === 'firefox' ? 200 : 100; // 200 ms timeout for Firefox v.55\n\nlet jazzInstanceNumber = 0;\nconst jazzInstances = new Store();\n\n\nexport function createJazzInstance(callback) {\n    const id = `jazz_${jazzInstanceNumber}_${Date.now()}`;\n    jazzInstanceNumber += 1;\n    let objRef;\n    let activeX;\n\n    if (getDevice().nodejs === true) {\n        // jazzMidi is added to the global variable navigator in the node environment\n        objRef = new navigator.jazzMidi.MIDI();\n    } else {\n        /*\n            generate this html:\n\n            <object id=\"Jazz1\" classid=\"CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90\" class=\"hidden\">\n                <object id=\"Jazz2\" type=\"audio/x-jazz\" class=\"hidden\">\n                    <p style=\"visibility:visible;\">This page requires <a href=http://jazz-soft.net>Jazz-Plugin</a> ...</p>\n                </object>\n            </object>\n        */\n\n        activeX = document.createElement('object');\n        activeX.id = `${id}ie`;\n        activeX.classid = 'CLSID:1ACE1618-1C7D-4561-AEE1-34842AA85E90';\n\n        objRef = document.createElement('object');\n        objRef.id = id;\n        objRef.type = 'audio/x-jazz';\n\n        activeX.appendChild(objRef);\n\n        const p = document.createElement('p');\n        p.appendChild(document.createTextNode('This page requires the '));\n\n        const a = document.createElement('a');\n        a.appendChild(document.createTextNode('Jazz plugin'));\n        a.href = 'http://jazz-soft.net/';\n\n        p.appendChild(a);\n        p.appendChild(document.createTextNode('.'));\n\n        objRef.appendChild(p);\n\n        let insertionPoint = document.getElementById('MIDIPlugin');\n        if (!insertionPoint) {\n            // Create hidden element\n            insertionPoint = document.createElement('div');\n            insertionPoint.id = 'MIDIPlugin';\n            insertionPoint.style.position = 'absolute';\n            insertionPoint.style.visibility = 'hidden';\n            insertionPoint.style.left = '-9999px';\n            insertionPoint.style.top = '-9999px';\n            document.body.appendChild(insertionPoint);\n        }\n        insertionPoint.appendChild(activeX);\n    }\n\n\n    setTimeout(() => {\n        let instance = null;\n        if (objRef.isJazz === true) {\n            instance = objRef;\n        } else if (activeX.isJazz === true) {\n            instance = activeX;\n        }\n        if (instance !== null) {\n            instance._perfTimeZero = performance.now();\n            jazzInstances.set(jazzInstanceNumber, instance);\n        }\n        callback(instance);\n    }, jazzPluginInitTime);\n}\n\n\nexport function getJazzInstance(type, callback) {\n    const key = type === 'input' ? 'inputInUse' : 'outputInUse';\n    let instance = null;\n\n    const values = jazzInstances.values();\n    for (let i = 0; i < values.length; i += 1) {\n        const inst = values[i];\n        if (inst[key] !== true) {\n            instance = inst;\n            break;\n        }\n    }\n\n    if (instance === null) {\n        createJazzInstance(callback);\n    } else {\n        callback(instance);\n    }\n}\n"]}